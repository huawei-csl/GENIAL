#!/bin/bash

uv --quiet pip install .

set +e

# OMP_NUM_THREADS for lightgbm
# sleep infinity
PYTHONPATH=$(pwd) OMP_NUM_THREADS=1 python -u flowy/flows/reinforce/run/statistical/run_flow_cmd.py --bitwidth 4 --mockturtle_chains 1 --mockturtle_chain_len 20 --mockturtle_chain_workers 1 --use_mockturtle --encoding_permutation_id 0 --iterations 1 --env_option auto --experiment genial --recipe_selection ALL --save_option datarecord_compact --strategy_name equal --verilog_file /data/tmp/tmp03979bv2/mydesign_hdl/mydesign_comb.v --selection_metric mockturtle_gates --n_best_select 2 --scripts_per_step 1 --compression_scripts_per_step 3 --skip_intermediate_metrics_extraction --successive_compressions 1 --debug --input_encoding twos_complement --output_encoding twos_complement --operation multiplication --simulation_tb_final --tb_params_sim_mode normal_random --tb_params_nb_iter 40 --tb_params_std 3.0 --tb_params_mean 0.0 --tb_params_start_idx 0 --encoding_dict_json_filepath /data/tmp/tmp03979bv2/encoding_dict.json > /data/output.txt
#PYTHONPATH=$(pwd) OMP_NUM_THREADS=1 python -u flowy/flows/reinforce/run/statistical/run_flow_cmd.py --bitwidth 4 --mockturtle_chains 1 --mockturtle_chain_len 20 --mockturtle_chain_workers 1 --use_mockturtle --encoding_permutation_id 0 --iterations 1 --env_option auto --experiment genial --recipe_selection ALL --save_option datarecord_compact --strategy_name equal --verilog_file /data/tmp/tmp03979bv2/mydesign_hdl/mydesign_comb.v --selection_metric mockturtle_gates --n_best_select 2 --scripts_per_step 1 --compression_scripts_per_step 3 --skip_intermediate_metrics_extraction --successive_compressions 1 --debug --input_encoding twos_complement --output_encoding twos_complement --operation multiplication --simulation_tb_final --tb_params_sim_mode normal_random --tb_params_nb_iter 40 --tb_params_std 3.0 --tb_params_mean 0.0 --tb_params_start_idx 0 --encoding_dict_json_filepath /data/tmp/tmp03979bv2/encoding_dict.json > /data/output.txt

# wait forever for debugging
# while true; do sleep 1000; done

mkdir -p /data/output
rsync -a --remove-source-files /app/flowy/./output/db /data/output # copy the output to the shared temp volume

chmod -R 777 /data # to make cleanup possible on docker volume


popd > /dev/null
